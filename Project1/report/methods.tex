\section{Trapped hard sphere Bose gas setup}
\label{sec:Trapped hard sphere Bose gas setup}
The trapped hard sphere Bose gas is a system of $N$ bosons in a trap with a hard core repulsion.
The trap we will use is either spherical (S) or elliptical (E) described by the potentials
\begin{equation}
	\label{eq:extpotential}
	V _{ext}(r) =
	{
	\left\{
	\begin{array}{lll}
		\frac{1}{2}m \omega _{ho}^2r^2                      & (S) \\
		\frac{1}{2}m[\omega _{ho}^2(x^2+y^2)+\omega _z^2z^2 & (E)
	\end{array}
	\right.
	}
\end{equation}
The trial wave function is given by
\begin{equation}
	\Psi _T(r) = \Psi _T(r_1, r_2, ..., r_N, \alpha , \beta ) = \left[\prod _{i=1}g(\alpha , \beta , r_i)\right]\left[\prod_{j<k}^{} f(a, |r_j-r_k|)\right],
\end{equation}
where $g(\alpha , \beta , \boldsymbol{r_i})$ is the trial wave function for a single particle in the trap and $f(a, |\boldsymbol{r_j}-\boldsymbol{r_k}|)$ is the correlation wave function for the two-body potential
\begin{equation}
	\label{eq:fgdef}
	g(\alpha, \beta , \boldsymbol{r_i}) = \exp(-\alpha (x_i^2 + y_i^2 + \beta z_i^2)), \quad f(a,|\boldsymbol{r_i}-\boldsymbol{r_j}|)=
	{
	\left\{
	\begin{array}{lll}
		0                                                & \mbox{if } |\boldsymbol{r_i}-\boldsymbol{r_j}| \le a \\
		(1-\frac{a}{|\boldsymbol{r_i}-\boldsymbol{r_j}|} & \mbox{if } |\boldsymbol{r_i}-\boldsymbol{r_j}|>a.
	\end{array}
	\right.
	}
\end{equation}
The Hamiltonian operator $H$ for the system is given by
\begin{equation}
	\label{eq:Hamiltonian operator}
	H = \sum_{i=1}^{N} [\frac{-\hbar^2}{2m} \boldsymbol{\nabla_i}^2 + V _{ext}(r_i)] + \sum_{i<j}^{N} V _{int}(r_i,r_j).
\end{equation}
\
\section{Local energy} % (fold)
\label{sec:Local energy}
The local energy is given by
\begin{equation}
	\label{eq:local energy}
	E_L(r) = \frac{1}{\Psi _T(r)}H\Psi _T(r),
\end{equation}
\subsection{Trial wave function without two-body potential}
\label{sec:Trial wave function without two-body potential}
The trial wave function without two-body potential is given by
\begin{equation}
	\label{eq:trial wave function without two-body potential}
	\Psi_T(r) = \prod_{i}^{} \exp(-\alpha (x_i^2 + y_i^2 + \beta z_i^2)) .
\end{equation}
Using \autoref{eq:local energy} we find the local energy of a single particle in the trap to be
\begin{gather*}
	\frac{1}{\exp(-\alpha (x^2+y^2+\beta z^2))}\left[\frac{-\hbar^2}{2m} +\boldsymbol{\nabla}^2 + V _{ext}(r)\right]	\exp(-\alpha (x^2+y^2+\beta z^2)).
\end{gather*}
The laplace-operator $\Delta  = \grad^2$  acting on our trial wave function gives
\begin{gather*}
	\Delta \exp(-\alpha (x^2+y^2+\beta z^2)) = \exp(-\alpha (x^2+y^2+\beta z^2)) \left(4\alpha^2 (x^2+y^2+\beta^2 z^2) - 4 \alpha -2\alpha \beta \right).
\end{gather*}
With the spherical potential in \autoref{eq:extpotential} we have
\begin{gather*}
	V _{ext}(r) \Psi _T(r) = \frac{1}{2}m \omega _{ho}^2(x^2+y^2+z^2) \exp(-\alpha (x^2+y^2+\beta z^2)).
\end{gather*}
The local energy for a single particle in the trap is then given by
\begin{gather*}
	\frac{1}{exp(-\alpha (x^2+y^2+\beta z^2))}\left[\frac{-\hbar^2}{2m} \nabla^2 + V _{ext}(r)\right]	\exp(-\alpha (x^2+y^2+\beta z^2)) \\
	= \frac{1}{2}m \omega _{ho}^2(x^2+y^2+z^2) - \frac{\hbar ^2}{2m} \left(4\alpha^2 (x^2+y^2+\beta^2 z^2) - 4 \alpha -2\alpha \beta \right).\\
\end{gather*}
For spherical traps we have $\beta = 1$ and for non-interacting bosons we have $\alpha =\frac{1}{2}a ^2 _{ho}$. Inserting
these values we find the local energy to be
\begin{gather*}
	E_L(r) = \frac{1}{2}m \omega _{ho}^2(x^2+y^2+z^2) - \frac{\hbar ^2}{2m} \left(a _{ho}^4 (x^2+y^2+z^2) - 2 a^2 _{ho} -a^2 _{ho} \right) \\
	= (x^2+y^2+z^2)\left(\frac{1}{2}m\omega _{ho}^2-\frac{\hbar ^2}{2m}a^4 _{ho}\right)-3a^2 _{ho} \\
	= r^2 \left(\frac{1}{2}m\omega _{ho}^2-\frac{\hbar ^2}{2m}a^4 _{ho}\right)-3a^2 _{ho}.
\end{gather*}
We observe the local energy to be symmetric around the origin such that it is only dependent on the
length $r$ of the position vector $\boldsymbol{r}$.


For N particles in the same potential, the trial wave function is given by \autoref{eq:trial wave function without two-body potential}
with $\beta =1$ and $\alpha =\frac{1}{2}a^2 _{ho}$. This may be written as
\begin{gather*}
	\Psi_T(r) = \exp(-\alpha \sum_{i=1}^N (x_i^2 + y_i^2 + z_i^2)) .
\end{gather*}
The laplace-operator acting on the new wavefunction gives
\begin{gather*}
	\sum_{i=1}^{N} \Delta _{i} \exp(-\alpha (x_i^2+y_i^2+z_i^2)) \\
	=\exp(-\alpha \sum_{i=1}^N (x_i^2 + y_i^2 + z_i^2)) \left(4\alpha^2 \sum_{i=1}^N
	(x_i^2+y_i^2+z_i^2) - 4 \alpha N -2\alpha N \right).
\end{gather*}
Thus, the local energy for the wavefunction of N particles is given by
\begin{gather*}
E_L(r) =   \sum_{i=1}^{N}
\left(\frac{-2\hbar ^2 \alpha ^2}{m}\boldsymbol{r_i}^2+V _{ext}(\boldsymbol{r_i}) -
6 \alpha \right)\\
\end{gather*}

The drift force to be used in importance sampling is given by
\begin{gather*}
	F = \frac{2 \grad \Psi _T}{\Psi _T} = \frac{2\exp(-\alpha (x_i^2+y_i^2+z_i^2))(-2\alpha \boldsymbol{r_i})}{\exp(-\alpha (x_i^2+y_i^2+z_i^2))}
	= -4\alpha \boldsymbol{r_i}.
\end{gather*}

\subsection{Trial wave function with two-body potential}
\label{sec:Trial wave function with two-body potential}
We will assume multiple bosons interact pairwise with each other in elastic collisions
represented by the hard-sphere potential 
\begin{equation}
\label{eq:V_int}
\begin{gathered}
V _{int} (|\boldsymbol{r_i}-\boldsymbol{r_j}|)= 
	\left\{
		\begin{array}{lll}
			\infty & \mbox{if } |\boldsymbol{r_i}-\boldsymbol{r_j}|
			\le a \\
			0 & \mbox{else.} 
		\end{array}
	\right.
\end{gathered}
\end{equation}
The trial wave function of a system of bosons is given by
\begin{equation}
	\label{eq:trial wave function with two-body potential}
	\Psi_T(r) = \left( \prod_{i}^{}g(\alpha ,\beta ,\boldsymbol{r_i})\right) \prod_{j<k}^{} f(a,|\boldsymbol{r_j-r_k}|).
\end{equation}
% section section name (end)
Defining the quantities
\begin{equation}
	\label{eq:definitions}
	\begin{gathered}
		r _{ij} = |\boldsymbol{r_i-r_j}|,\\
		ø(\boldsymbol{r_i})=\text{g}(\alpha ,\beta ,\boldsymbol{r_i})\quad \text{and}\\
		u(r _{ij})= \ln(f(r _{ij})),
	\end{gathered}
\end{equation}
we rewrite the trial wave function as
\begin{gather*}
	\Psi_T(r) = \left( \prod_{i}^{}ø(\boldsymbol{r_i})\right) \exp\left(\sum_{j<k}^{} u(r _{jk})\right),
\end{gather*}
where
\begin{gather*}
	\sum_{i<j}^{N} X _{ij}\equiv \sum_{i=1}^{N} \sum_{j=i+1}^{N} X _{ij}.
\end{gather*}
Using the product rule, we find the first derivative of particle $k$ to be
\begin{gather*}
	\grad _{k} \Psi _{T}(\boldsymbol{r}) = \grad _{k}ø(\boldsymbol{r_k})\prod_{i\neq k}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right) + \prod_{i}^{}ø(\boldsymbol{r_i})\grad _k\exp\left(\sum_{j<m}^{} u(r _{jm})\right)\\
	= \grad _{k}ø(\boldsymbol{r_k})\prod_{i\neq k}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right) + \prod_{i}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right)\grad_k \sum_{j<m}^{} u(r _{jm})\\
	= \grad _{k}ø(\boldsymbol{r_k})\prod_{i\neq k}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right) + \prod_{i}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right) \sum_{l \neq  k} \boldsymbol{\nabla} _ku(r _{kl}).
\end{gather*}
Applying the gradient again using the product rule, we find the laplace-operator acting on the trial wave function to be
\begin{gather*}
	\Delta _{k} \Psi _{T}(\boldsymbol{r}) = \Delta _{k}ø(\boldsymbol{r_k})\prod_{i\neq k}^{}ø(\boldsymbol{r_i})
	\exp\left(\sum_{j<m}^{} u(r _{jm})\right) + \grad _{k}ø(\boldsymbol{r_k})\prod_{i\neq k}^{}ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm})\right) \sum_{l \neq  k} \boldsymbol{\nabla} _ku(r _{kl})\\
	+\boldsymbol{ \nabla }_kø(\boldsymbol{r_k}) \prod_{i \neq k}^{} ø(\boldsymbol{r_i})
	\exp\left(\sum_{j<m}^{} u(r _{jm})\right) \sum_{l \neq  k} \boldsymbol{\nabla} _ku(r _{kl}) + \prod_{i}^{}
	ø(\boldsymbol{r_i}) \exp\left(\sum_{j<m}^{} u(r _{jm})\right) \sum_{j \neq k}^{} \boldsymbol{\nabla }_ku(r _{kj})\sum_{l \neq k}^{} \boldsymbol{\nabla }_ku(r _{kl}) \\
	+\prod_{i}^{} ø(\boldsymbol{r_i})\exp\left(\sum_{j<m}^{} u(r _{jm}	)\right)
	\sum_{i \neq k} \boldsymbol{\nabla ^2} _ku(r _{ki}).
\end{gather*}
Dividing this expression with the trial wave function, we get
\begin{gather*}
	\frac{\Delta _{k} \Psi _{T}(\boldsymbol{r})}{\Psi _{T}(\boldsymbol{r})}\\
	=\Delta _{k}ø(\boldsymbol{r_k})\frac{1}{ø(\boldsymbol{r_k})} + \grad _{k}ø(\boldsymbol{r_k}) \frac{1}{ø(\boldsymbol{r_k})} \sum_{l \neq  k} \boldsymbol{\nabla} _ku(r _{kl})\\
	+\boldsymbol{ \nabla }_kø(r_k)  \frac{1}{ø(\boldsymbol{r_k})} \sum_{l
		\neq  k} \boldsymbol{\nabla} _ku(r _{kl}) + \sum_{j \neq k}^{}
	\grad_ku(r _{kj})\sum_{l \neq k}^{} \grad_ku(r _{kl})
	+\sum_{i \neq k} \grad^2 _ku(r _{ki})\\
	=\Delta _{k}ø(\boldsymbol{r_k})\frac{1}{ø(\boldsymbol{r_k})} + \grad
	_{k}ø(\boldsymbol{r_k}) \frac{1}{ø(\boldsymbol{r_k})} \sum_{l \neq  k}
	u'(r _{kl})\boldsymbol{\nabla} _kr _{kl} \\
	+\boldsymbol{ \nabla }_kø(r_k)  \frac{1}{ø(\boldsymbol{r_k})} \sum_{l
		\neq  k} u'(r _{kl})\boldsymbol{\nabla} _k r _{kl}+ \sum_{j \neq k}^{}
	u'(r _{kj})\grad_k r _{kj}\sum_{l \neq k}^{} u'(r _{kl})\grad_k r _{kl}
	+\sum_{i \neq k} \left(u''(r _{ki})(\grad _k r _{ki})^2+u'(r _{ki})\grad ^2
	r _{ki}\right).
\end{gather*}
By the definition of $r _{ij}$ in \autoref{eq:definitions}, we find
\begin{gather*}
	\sum_{l \neq k }^{} \grad _k r _{kl} = \sum_{l \neq k }^{} \grad _k |\boldsymbol{r_k}-\boldsymbol{r_l}| = \sum_{l \neq k }^{} \frac{1}{2|\boldsymbol{r_k}-\boldsymbol{r_l}|}2(\boldsymbol{r_k}-\boldsymbol{r_l})\\
	= \sum_{l \neq k }^{} \frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r _{kl}}, \quad \text{and}\\
	\sum_{l \neq k}^{} \grad^2 _k r _{kl} = \sum_{l \neq k}^{} \left( \frac{3r _{kl}-(\boldsymbol{r_k}-\boldsymbol{r_l})\frac{1}{2r _{kl}}2(\boldsymbol{r_k}-\boldsymbol{r_l})}{r _{kl}^2}\right)\\
	= \sum_{l \neq k}^{} \frac{2}{r _{kl}} ,
\end{gather*}
such that
\begin{gather*}
	\frac{\Delta_k \Psi _T(\boldsymbol{r})}{\Psi _T(\boldsymbol{r})} = \\
	= \frac{\boldsymbol{\nabla} ^2ø(\boldsymbol{r_k})}{ø(\boldsymbol{r_k})}+ 2 \frac{\boldsymbol{\nabla }_k ø(\boldsymbol{r_k})}{ø(\boldsymbol{r}_k)}\sum_{l \neq k}^{} u'(r _{kl}) \frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r _{kl}}
	+\sum_{j \neq k}^{} u'(r _{kj})
	\frac{\boldsymbol{r_k}-\boldsymbol{r_j}}{r _{kj}}
	\sum_{l \neq k}^{} u'(r _{kl})\\
	\frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r _{kl}}+ \sum_{i \neq k}
	\left[u''(r _{kl}) \left( \frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r
			_{kl}}\right)^2+\frac{2}{r _{kl}}u'(r _{kl})\right]\\
	=\frac{\boldsymbol{\nabla} ^2ø(\boldsymbol{r_k})}{ø(\boldsymbol{r_k})}+ 2 \frac{\boldsymbol{\nabla }_k ø(\boldsymbol{r_k})}{ø(\boldsymbol{r}_k)}\sum_{l \neq k}^{} u'(r _{kl}) \frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r _{kl}}
	+\sum_{j \neq k}^{} \sum_{l \neq k}^{} u'(r _{kl})u'(r
		_{kj})\frac{(\boldsymbol{r_k}-\boldsymbol{r_j})(\boldsymbol{r_k}-\boldsymbol{r_l})}{r
		_{kj}r _{kl}}\\
	+\sum_{i \neq k}^{} \left[u''(r _{ki})+\frac{2}{r _{ki}}u'(r _{ki})\right].
\end{gather*}
Remembering the definitions from \autoref{eq:definitions} and
\autoref{eq:fgdef}, we have
\begin{gather*}
	ø(\boldsymbol{r_i}) = \exp(-\alpha \boldsymbol{r_i}^2), \quad \text{and}
	\quad u(r _{kl})=\ln(1-\frac{a}{r _{kl}}),\\
\end{gather*}
such that
\begin{gather*}
	\grad_kø(\boldsymbol{r_k}) = -2\alpha \exp(-\alpha \boldsymbol{r_k}^2)
	\boldsymbol{r_k},\\
	\grad^2_k ø(\boldsymbol{r}_k) = 4\alpha^2 \exp(-\alpha
	\boldsymbol{r_k}^2)\boldsymbol{r_k}^2-2\alpha \exp(-\alpha
	\boldsymbol{r_k}^2)3=\exp(-\alpha \boldsymbol{r_k}^2)(4\alpha ^2
	\boldsymbol{r_k}^2-6\alpha ),\\
	u'(r _{kl}) = \frac{\partial \ln(f(r _{kl}))}{\partial r _{kl}} =
	\frac{a}{r _{kl}^2-ar _{kl}},\\
	u''(r _{kl}) = \frac{a^2-2ar _{kl}}{(r _{kl}^2-ar _{kl})^2}.
\end{gather*}
Inserting these into the above equation, we find
\begin{gather*}
	\frac{\Delta _k \Psi_T(\boldsymbol{r})}{\Psi _T}= \frac{\exp(-\alpha
		\boldsymbol{r_k}^2)(4\alpha ^2 \boldsymbol{r_k}^2-6\alpha )}{\exp(-\alpha
		\boldsymbol{r_k}^2)}
	+2 \frac{-2\alpha \exp(-\alpha\boldsymbol{r_k}^2)\boldsymbol{r_k}}{\exp(-\alpha \boldsymbol{r_k}^2)}
	\sum_{l \neq k}^{}\frac{a}{r _{kl}^2-ar _{kl}}\frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{r_{kl}}\\
	+\sum_{j \neq k}^{}\sum_{l \neq k}^{}\frac{a}{r _{kl}^2-ar_{kl}}
	\frac{a}{r _{kj}^2-ar_{kj}}\frac{(\boldsymbol{r_k}-\boldsymbol{r_j})
	(\boldsymbol{r_k}-\boldsymbol{r_l})}{r_{kj}r _{kl}}\\
	+ \sum_{i \neq k}^{} \left[\frac{a^2-2ar _{ki}}{(r _{ki}^2-ar _{ki})^2}+\frac{2a}{r _{ki}^3-ar _{ki}^2}\right]\\
	= 4\alpha ^2 \boldsymbol{r_k}^2-6\alpha -4\alpha \boldsymbol{r_k} \sum_{l \neq k}^{}\frac{\boldsymbol{r_k}-\boldsymbol{r_l}}{\frac{r_{kl}^3}{a}-r _{kl}^2}
	+\sum_{j \neq k}^{}\sum_{l \neq k}^{}\frac{a^2(\boldsymbol{r_k}-\boldsymbol{r_j})(\boldsymbol{r_k}-\boldsymbol{r_l})}{(r _{kl}^2-ar _{kl})(r _{kj}^2-ar _{kj})(r _{kl}r _{kj})}\\
	+ \sum_{i \neq k}^{} \left[\frac{a^2-2ar _{ki}}{(r _{ki}^2-ar _{ki})^2}+\frac{2a}{r _{ki}^3-ar _{ki}^2}\right].
\end{gather*}
% section section name (end)
